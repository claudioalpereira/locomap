
@{
    ViewBag.Title = "MapView";
}

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css' rel='stylesheet' />

<style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }
</style>


<div id='map'></div>

<script>
//mapboxgl.accessToken = 'pk.eyJ1IjoicGV0ZXJxbGl1IiwiYSI6ImpvZmV0UEEifQ._D4bRmVcGfJvo1wjuOpA1g';
mapboxgl.accessToken = 'pk.eyJ1IjoiY2xlYWxwIiwiYSI6ImNpb3B3cm5rOTAwMDB3OG1ib2h6cTV0M3UifQ.pwjQ3N47PhI5H2Amch1IGQ';
var map = new mapboxgl.Map({
    container: 'map',
    //style: 'mapbox://styles/mapbox/streets-v9',
    style: 'mapbox://styles/clealp/ciopx36on000yepncv9d50zhb',
    zoom: 0
});

var url = 'https://wanderdrone.appspot.com/';
    //map.setStyle('mapbox://styles/mapbox/light-v9');

var geoJson;

    /*
map.on('load', function () {

	
	window.setInterval(function() {
		update();
    }, 2000);


    map.addSource('drone', { type: 'geojson', data: geoJson });

	map.addLayer({
        "id": "drone",
        "type": "symbol",
        "source": "drone",
        "layout": {
            "icon-image": "rocket-15"
        }
    });
});
*/
function update() {

    geoJson.features.forEach(function (marker) {

        // create a HTML element for each feature
        var el = document.createElement('div');
        var xxx = document.createTextNode(marker.label);
        xxx.className = 'label';
        el.className = 'marker';
        el.appendChild(xxx);

        // make a marker for each feature and add to the map
        new mapboxgl.Marker(el, { offset: [-50 / 2, -50 / 2] })
        .setLngLat(marker.geometry.coordinates)
        .addTo(map);
    });



    /*
        var s = map.getSource('drone');
        if (s) {
            s.setData(geoJson);
            
            var bounds = new mapboxgl.LngLatBounds();

            markers.features.forEach(function (feature) {
                bounds.extend(feature.geometry.coordinates);
            });

            map.fitBounds(bounds);
        }
        */
}

function convertToGeoJson(json) {
    return {
        type: "FeatureCollection",
        features: json.map(function (e) {
            return {
                type: "Feature",
                label: e.Loco,
                properties: {
                    "marker-color": "#666",
                    "marker-size": "small",
                    "marker-symbol": "circle",
                    //"address": "64 Delancey St",
                    //"time_submitted": 1428941074549
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [e.Longitude, e.Latitude]
                }
            };
        })
    };
}

</script>


<script src="/Scripts/jquery.signalR-2.2.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>

<script type="text/javascript">
    
    $(function () {
        // Declare a proxy to reference the hub.
        var notifications = $.connection.messagesHub;

        //debugger;
        // Create a function that the hub can call to broadcast messages.
        notifications.client.updateMessages = function () {
            getAllMessages()
        };
        // Start the connection.
        $.connection.hub.start().done(function () {
            console.log("connection started");
            getAllMessages();
        }).fail(function (e) {
            alert(e);
        });
    });

    function getAllMessages()
    {
        //var tbl = $('#messagesTable');
        $.ajax({
            url: 'home/GetMessages',
            contentType: 'application/html ; charset:utf-8',
            type: 'GET',
            dataType: 'html'
        }).success(function (result) {

            geoJson = convertToGeoJson(JSON.parse(result));
           update();

        }).error(function () {
            alert('ERROR retrieving data from the server');
        });
    }
   
</script>
